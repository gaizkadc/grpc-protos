/*
 * Copyright (C) 2018 Nalej - All Rights Reserved
 */

syntax = "proto3";

package public_api;
option go_package = "github.com/nalej/grpc-public-api-go";

import "infrastructure/entities.proto";
import "application/entities.proto";
import "installer/entities.proto";

// --------------------------------
// Organization related entities.
// --------------------------------

// OrganizationInfo contains public organization information.
message OrganizationInfo {
    string organization_id = 1;
    string name = 2;
}

// --------------------------------
// Clusters
// --------------------------------

message Cluster {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // ClusterId with the cluster identifier.
    string cluster_id = 2;
    // Name of the cluster.
    string name = 3;
    // ClusterTypeName contains the name of the type of cluster.
    string cluster_type_name = 4;
    // MultitenantSupport contains the type of support definition.
    string multitenant_support = 5;
    // StatusName with the name if the status of the cluster based on monitoring information.
    string status_name = 6;
    // Labels for the cluster.
    map <string, string> labels = 7;
    // TotalNodes contains the total number of nodes in the cluster.
    int64 total_nodes = 8;
    // RunningNodes contains the number of nodes in the system that are currently working.
    int64 running_nodes = 9;
}

message ClusterList {
    repeated Cluster clusters = 1;
}

message UpdateClusterRequest {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // ClusterId with the cluster identifier.
    string cluster_id = 2;
    // UpdateName flag to determine if the name needs to be changed.
    bool update_name = 3;
    // Name of the cluster.
    string name = 4;
    // Add Label flag to indicate that the set of labels need to be added.
    bool add_labels = 5;
    // Remove label flag to indicate that the set of labels need to be removed.
    bool remove_labels = 6;
    // Labels for the cluster.
    map <string, string> labels = 7;
}

// Type of platform targetting this install request
enum Platform {
    // Minikube for local deployments
    MINIKUBE = 0;
    // Azure for cloud-based deployments
    AZURE = 1;
}

// InstallRequest message used to specify the cluster to be installed.
message InstallRequest {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // ClusterId with the cluster identifier.
    string cluster_id = 2;
    // Type of cluster.
    infrastructure.ClusterType cluster_type = 3;
    // InstallBaseSystem flag to indicate that the base system must be installed on the nodes.
    bool install_base_system = 4;
    // KubeConfigRaw contains the required data to connect to a Kubernetes cluster in case it is already installed.
    string kube_config_raw = 5;
    // Hostname of the cluster master. This value is used to connect to the app cluster ingress.
    string hostname = 6;
    // Username to connect to the remote machines when the base system needs to be installed.
    string username = 7;
    // PrivateKey contains the SSH private key required when the base system needs to be installed.
    string private_key = 8;
    // Nodes contains the list of IP addresses to be installed.
    repeated string nodes = 9;
    // Use Kube DNS configuration
    bool use_kube_dns = 10;
    // Use CoreDNS configuration
    bool use_core_dns = 11;
    // Target platform
    Platform target_platform = 12;
    // Static IP addresses
    installer.StaticIPAddresses static_ip_addresses = 13; 
}

// --------------------------------
// Nodes
// --------------------------------

// Node entity representing a single node of the architecture that executes application instances.
message Node {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // ClusterId with the associated cluster identifier the node is assigned to.
    string cluster_id = 2;
    // Id with the node identifier.
    string node_id = 3;
    // Ip with the node IP.
    string ip = 4;
    // Labels for the node.
    map<string, string> labels = 5;
    // StatusName of the node based on monitoring information.
    string status_name = 6;
    // StateName of assignation of the node.
    string state_name = 7;
}

message NodeList {
    repeated Node nodes = 1;
}

message UpdateNodeRequest {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // NodeId with the node identifier.
    string node_id = 2;
    // Add Label flag to indicate that the set of labels need to be added.
    bool add_labels = 3;
    // Remove label flag to indicate that the set of labels need to be removed.
    bool remove_labels = 4;
    // Labels for the cluster.
    map <string, string> labels = 5;
}

// --------------------------------
// Resources
// --------------------------------

message ResourceSummary {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    int64 total_clusters = 2;
    int64 total_nodes = 3;
}

// --------------------------------
// Users
// --------------------------------

// AddUserRequest message with the information required to add a user to the platform.
message AddUserRequest {
    string organization_id = 1;
    string email = 2;
    string password = 3;
    string name = 4;
    string role_name = 5;
}

// User model the information available regarding a User of an organization
message User {
    string organization_id = 1;
    string email = 2;
    string name = 3;
    string role_name = 4;
}

message UserList {
    repeated User users = 1;
}

// PasswordResetResponse contains an automatically generated password set for the user.
// In future versions, the password reset will be sent as a link in an email for the user to reset
// the password.
message PasswordResetResponse {
    string organization_id = 1;
    string email = 2;
    string new_password = 3;
}

// --------------------------------
// Roles
// --------------------------------

// Role defines a role for users of an organization with the associated capabilities
message Role {
    string organization_id = 1;
    string role_id = 2;
    string name = 3;
    repeated string primitives = 4;
}

message RoleList {
    repeated Role roles = 1;
}

// --------------------------------
// Applications
// --------------------------------

message Endpoint {
    string type_name = 1;
    string path = 2;
}

message Port {
    string name = 1;
    int32 internal_port = 2;
    int32 exposed_port = 3;
    repeated Endpoint endpoints = 4;
}

message Storage {
    int64 size = 1;
    string mount_path = 2;
    string type_name = 3;
}

message ServiceInstance {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // AppDescriptorId with the application descriptor identifier.
    string app_descriptor_id = 2;
    // AppInstanceId with the application instance identifier.
    string app_instance_id = 3;
    // ServiceGroupId with the group identifier.
    string service_group_id = 4;
    // ServiceGroupInstanceId with the service group instance identifier.
    string service_group_instance_id = 5;
    // ServiceId with the service identifier.
    string service_id = 6;
    // Unique identifier for this instance
    string service_instance_id = 7;
    // Name of the service.
    string name = 8;
    // ServiceType represents the underlying technology of the service to be launched.
    string type_name = 9;
    // Image contains the URL/name of the image to be executed.
    string image = 10;
    // ImageCredentials with the data required to access the repository the image is available at.
    application.ImageCredentials credentials = 11;
    // DeploySpecs with the resource specs required by the service.
    application.DeploySpecs specs = 12;
    // Storage restrictions
    repeated Storage storage = 13;
    // ExposedPorts contains the list of ports exposed by the current service.
    repeated Port exposed_ports = 14;
    // EnvironmentVariables defines a key-value map of environment variables and values that will be passed to all
    // running services.
    map<string, string> environment_variables = 15;
    // Configs contains the configuration files required by the service.
    repeated application.ConfigFile configs = 16;
    // Labels with the user defined labels.
    map<string, string> labels = 17;
    // DeployAfter contains the list of services that must be running before launching a service.
    repeated string deploy_after = 18;
    // Status of the deployed service
    string status_name = 19;
    // Endpoints exposed to the users by the service.
    repeated string endpoints = 20;
    // DeployedOnClusterId specifies which is the cluster where the service is running.
    string deployed_on_cluster_id = 21;
    // Run arguments
    repeated string run_arguments = 22;
    // Relevant information about this instance
    string info = 23;
    // DeploymentSelectors defines a key-value map of deployment selectors
    map<string, string> deployment_selectors = 24;
}

// SecurityRule structure defining which element can access a given application service.
message SecurityRule {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // AppDescriptorId with the application descriptor identifier.
    string app_descriptor_id = 2;
    // RuleId with the security rule identifier.
    string rule_id = 3;
    // Name of the security rule.
    string name = 4;
    // TargetServiceGroupName defining the name of the service to be accessed.
    string target_service_group_name = 5;
    // TargetServiceName name of the service belonging to be source group mentioned above to be accessed.
    string target_service_name = 6;
    // TargetPort defining the port that is affected by the current rule.
    int32 target_port = 7;
    // Access level to that port defining who can access the port.
    string access_name = 8;
    // AuthServices defining a list of services that can access the port.
    repeated string auth_services = 9;
    // DeviceGroups defining a list of device groups that can access the port.
    repeated string device_groups = 10;
}

// This is a common metadata entity that collects information for a deployed instance. This instance can be a
// service instance or a service group instance.
message InstanceMetadata {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // AppDescriptorId with the application descriptor identifier.
    string app_descriptor_id = 2;
    // AppInstanceId with the application instance identifier.
    string app_instance_id = 3;
    // Identifier of the monitored entity. This generic id can be used to monitor different kinds of objects.
    string monitored_instance_id = 4;
    // Type of instance this metadata refers to
    string type_name = 5;
    // List of instances supervised by this metadata structure
    repeated string instances_id = 6;
    // Number of desired replicas specified in the descriptor
    int32 desired_replicas = 7;
    // Number of available replicas for this instance
    int32 available_replicas = 8;
    // Number of unavailable replicas for this descriptor
    int32 unavailable_replicas = 9;
    // Status of every item monitored by this metadata entry
    map<string,string> status_name = 10;
    // Relevant information for every monitored instance
    map<string, string> info = 11;
}

// It specifies how to proceed deploying a service group. Some specs here may invalidate specific service deployment
// specs.
message ServiceGroupDeploymentSpecs {
    // How many times this service group must be replicated
    int32 num_replicas = 1;
    // Indicate if this service group must be replicated in every cluster
    bool multi_cluster_replica = 2;
}

// ServiceGroupInstance structure to represent a collection of services that must be deployed following a given collocation
// policy.
message ServiceGroupInstance {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // AppDescriptorId with the application descriptor identifier.
    string app_descriptor_id = 2;
    // AppInstanceId with the application instance identifier.
    string app_instance_id = 3;
    // ServiceGroupId with the group identifier.
    string service_group_id = 4;
    // Unique identifier for this instance
    string service_group_instance_id = 5;
    // Name of the service group.
    string name = 6;
    // ServicesInstances with the list of instance objects for this group
    repeated ServiceInstance service_instances = 7;
    // Policy indicating the deployment collocation policy.
    string policy_name = 8;
    // The status for this service group instance will be the worst status of its services
    string status_name = 9;
    // Metadata for this service group
    InstanceMetadata metadata = 10;
    // Particular deployment specs for this service
    ServiceGroupDeploymentSpecs specs = 11;
    // Labels defined by the user.
    map<string, string> labels = 12;
}

// AppInstance represents an instance of the application in the system.
message AppInstance {
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // AppDescriptorId with the application descriptor identifier.
    string app_descriptor_id = 2;
    // AppInstanceId with the application instance identifier.
    string app_instance_id = 3;
    // Name of the application.
    string name = 4;
    // ConfigurationOptions defines a key-value map of configuration options.
    map<string, string> configuration_options = 5;
    // EnvironmentVariables defines a key-value map of environment variables and values that will be passed to all
    // running services.
    map<string, string> environment_variables = 6;
    // Labels defined by the user.
    map<string, string> labels = 7;
    // Rules that define the connectivity between the elements of an application.
    repeated SecurityRule rules = 8;
    // Groups with the Service collocation strategies.
    repeated ServiceGroupInstance groups = 9;
    // Status of the deployed instance.
    string status_name = 10;
    // Metadata descriptor for the instances triggered by this app
    repeated InstanceMetadata metadata = 11;
}

message AppInstanceList {
    repeated AppInstance instances = 1;
}

// --------------------------------
// Devices
// --------------------------------
message Device{
    // OrganizationId with the organization identifier.
    string organization_id = 1;
    // DeviceGroupId with the device group identifier.
    string device_group_id = 2;
    // DeviceId with the device identifier.
    string device_id = 3;
    // RegisterSince is the timestamp when the device joined the group.
    int64 register_since = 4;
    // Labels defined by the user.
    map<string, string> labels = 5;
    // Enabled determines if the device can interact with the running applications.
    bool enabled = 6;
    // DeviceApiKey contains the API KEY used by the device to send data.
    string device_api_key = 7;
    // LatencyStatus contains the status of the device (ONLINE/OFFLINE)
    string latency_status_name = 8;
}
message DeviceList{
    repeated Device devices = 1;
}